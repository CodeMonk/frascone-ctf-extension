#! /usr/local/bin/ruby

require 'yaml'
require 'net/http'
require 'net/https'

def link_https?(server,path, username, password)
  http = Net::HTTP.new(server,443)
  req = Net::HTTP::Get.new(path)
  #https
  http.use_ssl = true
  req.basic_auth username, password
  begin
    http.request(req)
    return true
  rescue SocketError
    return false
  end
end

# For google code
GOOGLE_SERVER='ctf-extension.googlecode.com'
GOOGLE_PATH='/hg/'
CONF= YAML.load_file('.auths.yml')
USER = CONF['user']
PASSWD = CONF['passwd']
DEST_GOOGLE='https://'+USER+':'+PASSWD+'@'+GOOGLE_SERVER+GOOGLE_PATH

if ARGV.size < 1 then
  puts 'Please press the message and other parameters.'
  puts './push msg [args]'
  exit
end

# run hg *args
def hg(args)
  targs=['hg']
  args.each do |a|
    targs<<'"'+a.gsub('"','\"')+'"'
  end
  cmd = targs.join(' ')
  system cmd
end

ci = ['commit','-m']+ARGV
hg ci

# push to google code
if link_https?(GOOGLE_SERVER,GOOGLE_PATH,USER, PASSWD)
  ci = ['push', DEST_GOOGLE]
  hg ci
end

